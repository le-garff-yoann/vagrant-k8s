vrrp_script haproxy-check {
    script "killall -0 haproxy"
    interval 2
    weight 20
}

vrrp_instance haproxy-vip {
    state BACKUP
    priority 101
    interface eth1
    virtual_router_id 47
    advert_int 3

    unicast_src_ip {{ k8s_config._virtual.inventory[ansible_hostname] }}
    unicast_peer {
{% for k, v in k8s_config._virtual.inventory | dictsort %}
{% if v != k8s_config._virtual.inventory[ansible_hostname] %}
        {{ v }}
{% endif %}
{% endfor %}
    }

    virtual_ipaddress {
        {{ k8s_config._virtual.vip }}
    }

    track_script {
        haproxy-check weight 20
    }
}